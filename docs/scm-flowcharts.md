# SCM系统前后端功能交互流程图完整文档

> 文档版本：1.0  
> 创建时间：2026年2月4日  
> 文档用途：清晰展示SCM系统所有操作流程及前后端数据流转关系

---

## 第一章 系统总体架构与核心模块概览

### 1.1 系统架构概述

SCM协同管理系统采用前后端分离架构设计，整体架构由三个核心层级组成。最上层是表现层，包含买手管理端（Admin System）和商家协同端（Merchant System）两个独立的前端应用。中间层是服务层，基于Express框架构建的RESTful API服务，负责处理所有业务逻辑并与数据库进行交互。底层是数据层，采用Supabase作为后端服务提供商，存储所有业务数据、用户信息和系统配置。两个前端应用通过统一的API接口与服务层进行通信，共享同一套数据模型和业务规则，形成紧密耦合的协同工作体系。

系统的核心设计理念是实现买手与商家之间的高效协同。买手端侧重于全局资源管理、审批决策和数据监控，商家端则专注于日常业务执行、申请提交和进度跟踪。两个端通过统一的状态流转机制和事件驱动模式实现业务流程的闭环管理，确保业务数据的一致性和操作流程的完整性。整个系统的数据流转遵循严格的权限控制机制，不同角色的用户只能访问和操作其权限范围内的数据和功能。

### 1.2 核心功能模块清单

SCM系统包含两大端共十二个核心功能模块，每个模块承担特定的业务职责。买手端的六个核心模块分别是系统驾驶舱（Dashboard）、推款管理（PushManage）、核价工单管理（PricingOrderPage）、异常工单管理（AnomalyOrderPage）、店铺管理（ShopManage）和大货工单管理（BulkOrderPage）。商家端的六个核心模块分别是申请工作台（RequestWorkbench）、款式工作台（StyleWorkbench）、补货协同（ReplenishmentSynergy）和开发进度（DevelopmentProgress）。这些模块之间通过数据共享和事件触发形成有机的业务联动，共同支撑SCM系统的完整业务流程。

从功能分类角度来看，商品管理类模块包括推款管理、款式工作台和SPU库管理，负责款式的发布、接收和状态跟踪。订单处理类模块包括核价工单管理、异常工单管理、大货工单管理和补货协同，覆盖了从申请提交到订单完成的全生命周期管理。运营管理类模块包括店铺管理和标签管理，提供商家账号和系统配置的维护功能。数据监控类模块主要是系统驾驶舱，实时汇总展示系统关键指标和业务统计数据。

---

## 第二章 商家端完整操作流程图

### 2.1 商家端核心功能模块总览

商家端作为SCM系统中面向商家的操作界面，其核心职责是接收买手推送的款式、管理补货订单、提交各类申请以及跟踪业务进度。商家端的四个核心功能模块形成了完整的业务操作闭环：申请工作台负责向买手提交核价和异常类申请；款式工作台负责查看和接收买手推送的款式；补货协同负责处理补货订单的确认和发货；开发进度负责跟踪款式开发的完整过程。这四个模块相互协作，共同支撑商家在SCM系统中的日常业务操作。

商家端的操作流程设计遵循"被动响应与主动申请相结合"的原则。一方面，商家需要响应买手发起的推款、补货等业务，主动确认接单或执行发货操作。另一方面，商家也可以主动向买手提交核价申请、异常申请等业务请求。这种双向交互模式确保了买手与商家之间信息传递的及时性和对称性，是SCM系统实现高效协同的技术基础。

### 2.2 申请工作台操作流程

#### 2.2.1 流程总览

申请工作台是商家向买手提交各类申请的核心功能模块，支持核价申请、异常申请和款式申请三大类业务。核价申请用于调整商品售价或申请特殊价格政策；异常申请用于处理尺码问题、图片异常、商品下架等业务异常；款式申请用于提交新款式的开发需求。整个申请流程遵循"填写申请→提交等待→查看结果→补充二次申请"的完整闭环。

商家在申请工作台选择申请类型后，系统引导商家填写相应的申请信息。核价申请需要选择目标SKC并填写申请价格和理由；异常申请需要选择异常类型并关联商品编码；款式申请需要填写款式信息和设计说明。申请提交后，系统自动将申请记录写入数据库，并将状态设置为"处理中"，等待买手审批。买手完成审批后，商家可以查看买手的复核价格和反馈信息，如果对复核价格不满意，还可以提交二次申请。

#### 2.2.2 核价申请详细流程

核价申请是商家调整商品售价的主要渠道，支持同款同价、申请涨价、毛织类核价和非毛织类核价四种申请场景。商家在申请工作台选择核价类型后，系统引导商家选择需要调价的目标SKC，填写期望售价和申请理由。申请提交后，系统自动将申请记录写入数据库，并将状态设置为"处理中"，等待买手审批。买手完成审批后，商家可以查看买手的复核价格，如果对复核价格不满意，还可以提交二次申请。

**核价申请流程图：**

```
开始：选择核价类型
    ↓
选择子类型：同款同价 / 申请涨价 / 毛织类核价 / 非毛织类核价
    ↓
选择目标SKC商品
    ↓
填写申请价格
    ↓
填写申请理由
    ↓
确认提交
    ↓
POST /api/requests/quote
    ↓
后端创建申请记录
    ↓
设置status=processing
    ↓
返回申请ID
    ↓
等待买手审批（轮询监听）
    ↓
查看审批结果
    ↓
┌───────────────┐
│  审批通过？    │
└───────┬───────┘
    是  │  否
    ↓   ↓
查看复核价格  查看驳回原因
    ↓   ↓
价格满意？   结束或重新申请
┌───┴───┐
│       │
是      否
↓       ↓
结束    提交二次核价
        ↓
        填写新价格和理由
        ↓
        POST /api/requests/{id}/secondary-review
        ↓
        等待买手复核
        ↓
        返回"等待买手审批"步骤
```

#### 2.2.3 异常申请详细流程

异常申请用于处理业务运营过程中出现的各类异常情况，包括尺码问题（新增尺码、修改尺码）、图片异常（人台误判、换图误判）、申请下架和其他类型。商家选择异常类型后，需要关联对应的商品编码（SPU或SKC），并填写详细的异常描述。异常申请提交后进入买手处理队列，买手根据实际情况选择通过或驳回申请。异常申请的处理结果会同步更新相关商品的状态，确保业务数据的准确性。

**异常申请流程图：**

```
开始：选择异常类型
    ↓
┌───────────────────────────────┐
│  尺码问题 → 新增尺码/修改尺码  │
│  图片异常 → 人台误判/换图误判  │
│  申请下架                      │
│  其他类型                      │
└───────────────────────────────┘
    ↓
关联商品编码（SPU或SKC）
    ↓
填写异常描述
    ↓
提交异常申请
    ↓
POST /api/requests/anomaly
    ↓
后端创建异常记录
    ↓
设置status=processing
    ↓
等待买手处理
    ↓
买手查看异常详情
    ↓
买手审批操作
    ↓
┌───────────────┐
│  通过/驳回     │
└───────┬───────┘
    是  │  否
    ↓   ↓
更新商品状态  记录驳回原因
    ↓   ↓
通知商家完成  通知商家被驳
    ↓
商家查看处理结果
    ↓
流程结束
```

### 2.3 款式工作台操作流程

#### 2.3.1 私推接款详细流程

私推是买手面向特定商家定向推送款式的业务场景，具有精准匹配的特点。买手在创建私推时需要选择目标店铺，设置款式的基本信息和属性标签。私推创建后，商家可以在私推工作台看到推送的款式卡片，包括款式图片、名称、截止天数、备注等信息。商家决定接款后，款式状态从"new"变为"developing"，进入开发阶段；商家也可以选择放弃，款式恢复为可选状态。

**私推接款流程图：**

```
买手创建私推
    ↓
选择目标店铺
    ↓
上传款式图片
    ↓
填写款式信息
    ↓
设置视觉和风格标签
    ↓
提交私推
    ↓
POST /api/styles/private
    ↓
后端创建私推记录
    ↓
设置status=new
    ↓
返回创建结果
    ↓
商家端监听私推列表
    ↓
发现新私推款式
    ↓
展示款式卡片
    ↓
查看详情
    ↓
┌───────────────┐
│  决定操作      │
└───────┬───────┘
    是  │  否
    ↓   ↓
接受款式  放弃款式
    ↓   ↓
POST /api/  POST /api/
styles/{id}/  styles/{id}/
accept       abandon
    ↓   ↓
更新status=  记录放弃
developing   原因
    ↓   ↓
记录confirm_  恢复status
time         =new
    ↓   ↓
款式加入私推  从列表移除
列表
    ↓
通知买手已接款
```

#### 2.3.2 公池接款详细流程

公池是买手面向全体商家开放推送款式的业务场景，形成多商家竞争接款的机制。买手将款式推入公池后，所有商家都可以在公池浏览区看到这些款式，并表达接款意向。公池款式的接款采用配额管理机制，每个商家最多可接5个公池款式。当某个款式的接款数达到设定的最大值（默认3个）时，该款式自动从公池隐藏，不再接受新的接款申请。

**公池接款流程图：**

```
买手创建公池款式
    ↓
设置最大接款数max_intents=3
    ↓
设置接款期限
    ↓
上传款式信息
    ↓
设置标签分类
    ↓
推入公池
    ↓
POST /api/styles/public
    ↓
后端创建公池记录
    ↓
初始化intent_count=0
    ↓
初始化intent_user_ids=[]
    ↓
返回创建结果
    ↓
所有商家可见公池
    ↓
商家查看公池列表
    ↓
系统按规则排序
    ↓
优先级1：有1个意向的款式优先
    ↓
优先级2：发布10天以上的老款优先
    ↓
优先级3：新款式最后展示
    ↓
展示排序后的款式
    ↓
商家选择接款款式
    ↓
点击表达意向
    ↓
检查商家配额
    ↓
SELECT COUNT(*) FROM 公池 WHERE shop_id
    ↓
┌─────────────────┐
│  current >= 5？  │
└───────┬─────────┘
    是  │  否
    ↓   ↓
返回配额  处理接款
已满错误  意向
    ↓   ↓
禁用接款  intent_count
按钮     +=1
    ↓   ↓
    添加shop_id
    到intent_
    user_ids
    ↓
┌─────────────────────────┐
│  intent_count >= max_    │
│  intents？               │
└───────────┬─────────────┘
        是  │  否
        ↓   ↓
    隐藏该款式  返回接款
        ↓    成功
        通知已  更新商家
        接款商  配额统计
        家开始
        开发
        ↓
        款式加入
        商家私推
        列表
        ↓
        通知买手
        新接款
```

### 2.4 补货协同操作流程

#### 2.4.1 接单确认详细流程

商家在补货协同中看到买手发起的补货订单后，需要确认接单数量。系统默认实际接单数量等于计划数量，但商家可以根据实际情况填写小于计划数量的接单数（即砍量）。如果商家砍量，必须填写砍量理由作为买手审核的依据。接单确认提交后，系统根据是否砍量决定订单状态的流转：如果实际数量等于计划数量，订单直接进入生产中状态；如果实际数量小于计划数量，订单进入待买手复核状态，等待买手审核砍量申请。

**接单确认流程图：**

```
商家查看补货订单
    ↓
查看订单详情（商品信息、计划数量、截止日期）
    ↓
填写实际接单数量
    ↓
┌─────────────────┐
│  数量 = 计划数量？│
└───────┬─────────┘
    是  │  否
    ↓   ↓
直接确认  填写砍量
接单     理由
    ↓   ↓
    说明砍量
    原因
    ↓
    提交接单
    确认
    ↓
    POST /api/restock/{id}/confirm
    ↓
    后端处理接单
    ↓
    ┌─────────────────────┐
    │  实际数量 < 计划数量？│
    └─────────┬───────────┘
          是  │  否
          ↓   ↓
      设置status=  设置status
      待买手复核  =生产中
          ↓   ↓
      等待买手  通知商家
      审核     进入生产
          ↓
          买手审核砍量
          ↓
          ┌───────────┐
          │ 买手同意？│
          └─────┬─────┘
            是  │  否
            ↓   ↓
        设置status  拒绝砍量
        =生产中
            ↓   ↓
        通知商家  恢复原数量
        进入生产  重新确认
```

#### 2.4.2 发货与物流跟踪详细流程

订单进入生产阶段后，商家需要执行发货操作，将补货商品实物交付给买手。发货时商家需要填写物流单号（WB号）和物流公司信息，系统自动记录发货时间和发货数量。发货完成后，订单状态更新为"待买手确认入仓"，商家可以在补货协同中跟踪物流状态。买手收到实物并核对数量后，在买手端执行入仓确认操作，完成整个补货订单的闭环。

**发货与物流跟踪流程图：**

```
订单进入生产阶段
    ↓
商家准备发货
    ↓
查看待发货订单
    ↓
点击发货按钮
    ↓
填写物流信息
    ↓
输入物流单号WB号
    ↓
选择物流公司
    ↓
确认发货数量
    ↓
提交发货信息
    ↓
POST /api/restock/{id}/ship
    ↓
后端处理发货
    ↓
更新订单状态=待买手确认入仓
    ↓
创建物流记录
    ↓
记录wb_number和shippedQty
    ↓
返回发货成功
    ↓
商家端状态更新
    ↓
订单展示为待确认入仓
    ↓
继续跟踪物流状态
    ↓
定时轮询订单状态
    ↓
┌─────────────────┐
│  状态有变化？    │
└───────┬─────────┘
    是  │  否
    ↓   ↓
查看最新  继续轮询
状态
    ↓
┌─────────────────────┐
│  买手已确认入仓？    │
└─────────┬───────────┘
        是  │  否
        ↓   ↓
    展示入仓  等待确认
    确认信息
        ↓
        补货订单
        完成闭环
```

### 2.5 开发进度跟踪操作流程

开发进度模块跟踪款式从接款到开发成功的完整过程，是商家管理款式开发的核心工作台。款式的开发过程分为五个阶段：打样中（drafting）、改版帮看中（pattern）、改图帮看中（helping）、待上传SPU（ok）和开发成功（success）。商家在每个阶段都需要更新款式状态，可以上传SPU编码、向买手申请帮看意见，或者在必要时放弃开发。开发进度的实时同步确保买手能够及时了解款式开发状况。

**开发进度跟踪流程图：**

```
商家接款成功
    ↓
款式进入开发队列
    ↓
查看开发进度列表
    ↓
选择操作类型
    ↓
┌─────────────────────────────┐
│  更新开发状态？              │
│  → 打样中drafting           │
│  → 改版帮看中pattern         │
│  → 改图帮看中helping         │
│  → 待上传SPU ok              │
│  → 开发成功success           │
└─────────────────────────────┘
    ↓
更新状态并保存
    ↓
┌─────────────────────────────┐
│  状态 = 待上传SPU？         │
└──────────────┬──────────────┘
            是  │  否
            ↓   ↓
        填写SPU  买手端实时
        编码     同步
            ↓
            POST /api/development/{id}/status
            ↓
            更新spu_code
            ↓
            返回成功响应
            ↓
            更新款式管理
            列表
            ↓
            更新Dashboard
            统计
```

---

## 第三章 买手段完整操作流程图

### 3.1 系统驾驶舱操作流程

系统驾驶舱是买手端的首页和核心数据展示模块，承担着全局态势感知的关键职责。驾驶舱通过聚合多个API接口的数据，实时呈现系统的整体运行状态，包括钥匙数量、店铺数量、SPU总数等基础统计，以及待处理的各类工单数量、推送统计等业务数据。买手登录系统后首先进入驾驶舱，可以一目了然地掌握当前业务状况，快速定位需要处理的任务。

**系统驾驶舱数据流程图：**

```
买手登录系统
    ↓
自动进入Dashboard
    ↓
并行发起数据请求
    ↓
┌─────────────────────────────────────┐
│  GET /api/admin/dashboard           │
│  → 返回系统统计数据                  │
│  GET /api/styles/private             │
│  → 返回私推款式                      │
│  GET /api/styles/public              │
│  → 返回公池款式                      │
└─────────────────────────────────────┘
    ↓
处理系统统计
    ↓
提取key_count、shop_count、spu_count等
    ↓
更新统计卡片展示
    ↓
处理私推统计
    ↓
统计私推状态分布
    ↓
计算privatePending、privateAccepted、privateInProgress
    ↓
展示私推统计
    ↓
处理公池统计
    ↓
统计公池数据分布
    ↓
计算publicTotal、publicFull、publicIntent
    ↓
展示公池统计
    ↓
整合展示系统驾驶舱
    ↓
展示统计卡片、推送统计、店铺等级分布
    ↓
定时自动刷新（每5秒）
    ↓
买手可手动点击刷新
```

### 3.2 推款管理操作流程

#### 3.2.1 私推创建详细流程

创建私推时，买手需要填写完整的款式信息并选择推送目标。款式信息包括图片上传、参考链接、备注说明、视觉风格和款式风格。店铺选择采用搜索下拉模式，买手可以输入店铺名称进行模糊搜索，支持单选或多选功能。私推创建后，系统自动向被选中店铺的私推列表添加该款式，同时更新相关统计数据。商家端通过轮询监听机制实时发现新推送的款式。

**私推创建流程图：**

```
进入私推表单
    ↓
上传款式图片
    ↓
填写参考链接
    ↓
填写备注说明
    ↓
选择视觉风格
    ↓
┌───────────────────────┐
│  人模 / 平铺 / 挂拍 /  │
│  细节图               │
└───────────────────────┘
    ↓
选择款式风格
    ↓
┌─────────────────────────────┐
│  优雅风 / 休闲风 / 通勤风 / │
│  法式风 / 韩系风 / 甜酷风 / │
│  极简风                    │
└─────────────────────────────┘
    ↓
搜索目标店铺
    ↓
输入店铺名称关键字
    ↓
过滤店铺列表
    ↓
选择目标店铺（可多选）
    ↓
确认推送
    ↓
验证表单数据
    ↓
┌─────────────────┐
│  验证通过？      │
└───────┬─────────┘
    是  │  否
    ↓   ↓
POST /  提示错误
api/    信息
styles/
private
    ↓
后端创建私推记录
    ↓
设置status=new
    ↓
关联目标店铺
    ↓
返回创建结果
    ↓
更新推送统计
    ↓
通知目标店铺商家
    ↓
展示推送成功提示
```

#### 3.2.2 公池推送详细流程

创建公池推送时，买手需要设置款式的最大接款数（默认3个），控制公池款式的竞争激烈程度。公池款式推入后对所有商家可见，商家可以自由表达接款意向。公池推送适合买手希望最大化款式曝光度、与更多商家建立合作关系的业务场景。公池款式的排序规则确保有剩余名额的款式优先展示，促进资源的有效分配。

**公池推送流程图：**

```
进入公池表单
    ↓
上传款式图片
    ↓
填写款式名称
    ↓
设置最大接款数
    ↓
默认max_intents=3
    ↓
可调整接款上限
    ↓
最多允许接款店铺数
    ↓
选择视觉风格
    ↓
选择风格标签（多选组合）
    ↓
确认推入公池
    ↓
POST /api/styles/public
    ↓
后端创建公池记录
    ↓
设置intent_count=0
    ↓
设置intent_user_ids=[]
    ↓
返回创建结果
    ↓
公池列表更新
    ↓
所有商家可见新款式
    ↓
按规则排序展示
    ↓
有剩余名额优先
    ↓
发布10天以上优先
    ↓
等待商家接款意向
    ↓
监控接款动态
    ↓
┌─────────────────────────┐
│  接款数达到上限？        │
└───────────┬─────────────┘
        是  │  否
        ↓   ↓
    隐藏该  继续等待
    款式   接款
        ↓   ↓
    通知已接款商家
        ↓
        开始开发阶段
```

### 3.3 审批工单操作流程

#### 3.3.1 核价审批详细流程

买手在核价工单管理中处理商家提交的核价申请。系统展示待处理的核价工单列表，按提交时间排序。买手点击工单查看详情后，可以选择初核通过、提交复核或驳回申请三种操作。初核通过时，买手需要填写买手复核价格；如需复核，则设置复核价格后工单进入待复核状态，等待商家二次申请后买手再次审核。审批结果通过实时同步机制通知商家端。

**核价审批流程图：**

```
买手进入核价工单管理
    ↓
查看待处理列表
    ↓
筛选条件：状态=待处理
    ↓
按提交时间排序
    ↓
选择待处理工单
    ↓
查看工单详情
    ↓
展示申请信息
    ↓
显示目标SKC列表、申请价格、申请理由
    ↓
买手审批操作
    ↓
填写买手复核价格
    ↓
选择操作类型
    ↓
┌─────────────────────────────┐
│  初核通过 / 提交复核 / 驳回   │
└─────────────────────────────┘
    ↓
初核通过：确认复核价格
    ↓
POST /api/requests/{id}/audit
    ↓
action=approve
    ↓
更新status=approved
    ↓
设置buyerPrice
    ↓
通知商家审批完成
    ↓
提交复核：设置复核价格
    ↓
设置status=待复核
    ↓
等待商家二次申请
    ↓
买手查看二次申请
    ↓
最终审批决定
    ↓
返回"买手审批操作"步骤
    ↓
驳回申请：填写驳回原因
    ↓
POST /api/requests/{id}/audit
    ↓
action=reject
    ↓
更新status=rejected
    ↓
记录feedback
    ↓
通知商家申请被驳
    ↓
商家端状态同步
    ↓
更新工单状态展示
```

#### 3.3.2 异常审批详细流程

买手在异常工单管理中处理商家提交的各种异常申请，包括尺码问题、图片异常、申请下架等。不同类型的异常申请需要买手关注不同的处理要点：尺码问题需要核实商品的实际尺码信息；图片异常需要判断是否存在拍摄或判断偏差；申请下架需要评估商品下架的合理性和影响范围。买手根据实际情况选择通过或驳回申请，处理结果实时同步至商家端和相关商品数据。

**异常审批流程图：**

```
买手进入异常工单管理
    ↓
查看待处理列表
    ↓
筛选：状态=待处理
    ↓
可按异常类型筛选
    ↓
┌─────────────────────────────┐
│  尺码问题 / 图片异常 /        │
│  申请下架 / 其他类型          │
└─────────────────────────────┘
    ↓
查看对应详情
    ↓
尺码问题 → 查看尺码详情
    ↓
图片异常 → 查看图片信息
    ↓
申请下架 → 查看下架原因
    ↓
其他类型 → 查看异常描述
    ↓
审核操作
    ↓
┌───────────────────┐
│  通过 / 驳回       │
└───────┬───────────┘
    是  │  否
    ↓   ↓
更新商品状态  填写驳回原因
    ↓   ↓
尺码更新/     更新status
图片更新/     =rejected
下架处理
    ↓   ↓
通知商家处理完成  记录驳回原因
    ↓   ↓
记录处理结果   通知商家被驳
    ↓   ↓
商家查看驳回原因
    ↓
流程结束
```

### 3.4 补货订单管理操作流程

#### 3.4.1 补货发起详细流程

买手在大货工单管理中创建补货订单，向商家发起补货请求。创建补货订单时，买手需要选择目标商家和补货商品，填写计划数量和截止日期。补货订单创建后进入待商家确认状态，系统自动通知相关商家进行接单确认。买手可以在补货管理中跟踪订单的确认、生产、发货和入仓进度，确保补货流程顺畅进行。

**补货发起流程图：**

```
买手进入大货工单管理
    ↓
点击新建补货订单
    ↓
填写补货信息
    ↓
选择目标商家
    ↓
搜索店铺名称
    ↓
选择目标店铺
    ↓
选择补货商品
    ↓
输入或选择SKC编码
    ↓
显示商品图片和名称
    ↓
确认选择
    ↓
填写补货数量
    ↓
设置计划数量
    ↓
设置截止日期
    ↓
填写备注说明
    ↓
提交补货订单
    ↓
POST /api/admin/restock
    ↓
后端创建订单
    ↓
设置status=confirming
    ↓
创建物流记录
    ↓
返回订单ID
    ↓
通知商家待确认
    ↓
商家端可见新订单
    ↓
买手等待商家确认
    ↓
跟踪确认状态
    ↓
┌─────────────────────┐
│  商家已确认？         │
└─────────┬───────────┘
        是  │  否
        ↓   ↓
    查看确认  继续等待
    数量
        ↓
        ┌─────────────────────┐
        │  商家有砍量？         │
        └─────────┬───────────┘
              是  │  否
              ↓   ↓
          审核砍量  订单进入
          申请     生产阶段
              ↓
              同意或拒绝砍量
              ↓
              ┌───────────────┐
              │  同意？        │
              └───────┬───────┘
                是  │  否
                ↓   ↓
            订单进入  拒绝砍量
            生产阶段
                ↓
                等待商家发货
```

#### 3.4.2 入仓确认详细流程

商家发货后，补货订单进入待买手确认入仓状态。买手收到实物后，需要在系统中执行入仓确认操作，确认到货数量与发货数量一致。入仓确认完成后，订单状态更新为"已确认入仓"，整个补货订单流程闭环完成。如果到货数量与发货数量不符，买手可以调整实际到货数量后确认入仓，系统自动记录差异情况。

**入仓确认流程图：**

```
商家发货完成
    ↓
订单状态更新为待确认入仓
    ↓
买手端可见待确认订单
    ↓
买手收到实物
    ↓
核对发货数量和实物
    ↓
点击确认入仓
    ↓
填写到货数量
    ↓
核对数量一致
    ↓
┌─────────────────┐
│  数量无误？      │
└───────┬─────────┘
    是  │  否
    ↓   ↓
直接确认  调整到货数量
    ↓   ↓
    填写实际到货数
    ↓
POST /api/restock/{id}/arrival
    ↓
后端处理入仓确认
    ↓
更新status=已确认入仓
    ↓
更新arrived_quantity
    ↓
记录arrived_at时间
    ↓
返回确认结果
    ↓
通知商家入仓确认
    ↓
商家端同步状态
    ↓
订单完成闭环
    ↓
生成补货统计
    ↓
更新Dashboard数据
```

### 3.5 店铺管理操作流程

店铺管理模块负责商家注册审批和店铺信息维护。当新商家通过网页注册系统提交注册申请后，申请进入待审批队列。买手在店铺管理中查看待审批的注册申请，可以批准或驳回申请。批准后，系统自动创建商家账号和店铺记录，建立买手与商家之间的业务关联关系。驳回时需要填写驳回原因，商家可以查看驳回信息后重新提交申请。

**店铺审批流程图：**

```
商家网页注册
    ↓
填写注册信息
    ↓
提交注册申请
    ↓
系统创建待审批用户
    ↓
设置status=pending
    ↓
等待买手审批
    ↓
买手进入店铺管理
    ↓
切换到待审批Tab
    ↓
查看待审批列表
    ↓
选择待审批用户
    ↓
查看申请详情
    ↓
显示用户名、店铺名、提交时间
    ↓
审批操作
    ↓
┌───────────────────┐
│  批准 / 驳回       │
└───────┬───────────┘
    是  │  否
    ↓   ↓
设置用户  填写驳回原因
status=  设置用户
approved status=
    ↓  rejected
创建店铺  记录reject_
记录    reason
    ↓   ↓
分配初  通知商家
始等级  申请被驳
N
    ↓   ↓
关联  商家查看驳回
key_id  原因
    ↓   ↓
通知  可重新提交
商家  申请
审批
通过
    ↓
商家登录系统
```

---

## 第四章 前后端数据流转完整流程图

### 4.1 整体数据流转架构

SCM系统的数据流转遵循"前端发起请求→后端处理业务→更新数据库→同步返回结果→前端更新展示"的完整链路。前端应用通过HTTP协议调用后端RESTful API接口，发送业务请求并接收处理结果。后端服务接收到请求后，进行参数校验、权限验证、业务逻辑处理和数据持久化操作，最终返回标准化响应。整个数据流转过程中，数据库作为唯一的数据存储和读取源，确保了数据的一致性和完整性。

**系统数据流转总览图：**

```
┌─────────────────┐         HTTP请求         ┌─────────────────┐
│   买手前端       │ ──────────────────────→ │   Express后端   │
│   Admin         │                         │   服务          │
└─────────────────┘                         └────────┬────────┘
                                                       │
                                                       ▼
┌─────────────────┐         HTTP请求         ┌─────────────────┐
│   商家前端       │ ──────────────────────→ │                 │
│   Merchant      │                         │   业务逻辑处理   │
└─────────────────┘                         │                 │
                                              ├─ 数据验证      │
                                              ├─ 权限检查      │
                                              ├─ 业务规则执行  │
                                              └─ 数据库操作    │
                                                       │
                                                       ▼
                                              ┌─────────────────┐
                                              │   Supabase      │
                                              │   数据库        │
                                              └────────┬────────┘
                                                       │
                                                       ▼
                                              ┌─────────────────┐
                                              │   数据持久化    │
                                              │   实时同步      │
                                              └────────┬────────┘
                                                       │
                                              ┌─────────┴─────────┐
                                              │                   │
                                              ▼                   ▼
                                      ┌─────────────────┐ ┌─────────────────┐
                                      │   响应买手前端   │ │   响应商家前端   │
                                      └────────┬────────┘ └────────┬────────┘
                                               │                   │
                                               ▼                   ▼
                                      ┌─────────────────┐ ┌─────────────────┐
                                      │   买手前端更新   │ │   商家前端更新   │
                                      │   展示          │ │   展示          │
                                      └─────────────────┘ └─────────────────┘
                                               │                   │
                                               └─────────┬─────────┘
                                                         │
                                                         ▼
                                              ┌─────────────────┐
                                              │   轮询监听机制   │
                                              │   (持续同步)    │
                                              └─────────────────┘
```

### 4.2 核心业务数据流转详解

#### 4.2.1 款式推送数据流转

款式推送是SCM系统最核心的业务场景，涉及买手端创建推送、商家端接收响应、后端状态同步的完整数据流转链路。买手创建私推时，系统向b_style_demand表写入款式记录；创建公推时向b_style_public表写入公池记录。商家接收款式时，后端更新对应记录的status和intent_count字段。状态变更通过轮询机制实时同步至两个前端应用，确保买手和商家看到的数据始终保持一致。

**款式推送数据流转图：**

```
【买手端】
创建私推表单 → POST /api/styles/private
    ↓
请求参数: image_url, ref_link, shop_id, tags
    ↓
【后端处理】
验证请求参数 → 生成UUID → INSERT b_style_demand → 设置默认值 → 返回创建结果
    ↓
【数据库】
b_style_demand表: id=UUID, status=new, created_at=NOW()
    ↓
【商家端轮询】
GET /api/styles/private?shop_id=xxx → 查询私推列表 → 返回款式列表 → 前端展示
    ↓
【商家操作接款】
点击接款按钮 → POST /api/styles/{id}/accept
    ↓
更新status=developing → 设置confirm_time=NOW() → 返回成功响应
    ↓
【买手端同步】
GET /api/admin/dashboard → 返回统计数据 → 更新privateAccepted数量
```

#### 4.2.2 申请审批数据流转

申请审批场景涉及b_request_record表的增删改查操作。商家提交申请时，系统向该表写入新记录，状态为processing。买手审批时，后端根据审批操作更新status字段和pricing_details/remark等字段。审批结果通过轮询机制同步至商家端，商家可以查看审批详情和反馈信息。整个数据流转过程中，b_request_record表作为核心数据表，记录了申请的全生命周期信息。

**申请审批数据流转图：**

```
【商家提交申请】
填写申请信息 → POST /api/requests/quote
    ↓
请求参数: type, sub_type, quotes, target_codes
    ↓
【后端处理】
后端创建记录
    ↓
【数据库b_request_record】
INSERT INTO b_request_record
    ↓
id=UUID, type='pricing', status='processing'
    ↓
pricing_details=申请详情, submit_time=NOW()
    ↓
返回记录ID
    ↓
【买手获取列表】
GET /api/requests?type=pricing&status=processing
    ↓
查询待处理记录 → 返回工单列表 → 前端展示待处理
    ↓
【买手审批操作】
买手填写审批信息 → POST /api/requests/{id}/audit
    ↓
action=approve/reject
    ↓
【数据库更新】
UPDATE b_request_record
    ↓
status='approved'或'rejected'
    ↓
pricing_details.buyerPrice=复核价格, remark=反馈信息
    ↓
返回成功响应
    ↓
【商家端同步】
轮询GET /api/requests?type=pricing → 发现状态变化 → 前端更新展示
```

#### 4.2.3 补货订单数据流转

补货订单的数据流转涉及b_restock_order表和b_restock_logistics表的协同操作。买手创建补货订单时，系统向b_restock_order表写入初始记录，状态为confirming。商家确认接单后，系统更新actual_quantity和status字段。商家发货时，系统同时更新b_restock_order的物流状态并向b_restock_logistics表插入物流记录。买手入仓确认后，系统完成最终状态的更新。

**补货订单数据流转图：**

```
【买手创建订单】
填写补货信息 → POST /api/admin/restock
    ↓
参数: skc_code, shop_id, plan_quantity
    ↓
【数据库b_restock_order】
INSERT INTO b_restock_order
    ↓
id=UUID, status='confirming'
    ↓
plan_quantity=计划数量, created_at=NOW()
    ↓
返回订单ID
    ↓
【商家确认接单】
GET /api/restock?status=confirming → 返回待确认订单
    ↓
填写接单数量 → POST /api/restock/{id}/confirm
    ↓
【数据库确认更新】
UPDATE b_restock_order
    ↓
actual_quantity=实际数量
    ↓
有砍量？→ status='待买手复核' | 无砍量 → status='生产中'
    ↓
返回确认结果
    ↓
【商家发货】
POST /api/restock/{id}/ship
    ↓
参数: wb_number, logisticsCompany, shippedQty
    ↓
更新订单物流 → INSERT b_restock_logistics → status='待买手确认入仓'
    ↓
【买手入仓确认】
POST /api/restock/{id}/arrival
    ↓
arrived_quantity=到货数量
    ↓
status='已确认入仓', arrived_at=NOW()
    ↓
返回确认结果
    ↓
【数据同步】
商家端轮询监听 → 状态更新展示
```

### 4.3 状态同步机制详解

SCM系统的前后端状态同步采用主动拉取（轮询）和被动推送相结合的策略。轮询机制确保前端能够及时获取最新的业务状态，适用于对实时性要求不高的业务场景。被动推送机制在关键业务节点触发状态更新，提供更及时的数据同步。两个前端应用根据不同的业务场景选择合适的同步策略，平衡数据实时性和系统性能。

**状态同步机制图：**

```
前端发起请求
    ↓
后端处理业务
    ↓
数据库更新
    ↓
返回处理结果
    ↓
前端即时更新（乐观更新）
    ↓
触发状态同步
    ↓
设置同步标识 → 更新缓存
    ↓
【轮询监听机制】
定时器触发
    ↓
GET API获取最新数据
    ↓
后端查询数据库
    ↓
返回数据列表
    ↓
前端比对状态
    ↓
┌─────────────────┐
│  状态有变化？     │
└───────┬─────────┘
    是  │  否
    ↓   ↓
更新前端  保持现状
状态
    ↓
等待下一轮定时
    ↓
【同步策略配置】
补货协同: 每30秒轮询
    ↓
申请工作台: 每60秒轮询
    ↓
系统驾驶舱: 每5秒刷新
    ↓
款式工作台: 每60秒轮询
```

---

## 第五章 关键业务场景完整流程图

### 5.1 推款到开发成功完整链路

从买手推款到商家开发成功是SCM系统最完整的业务链路，涵盖款式推送、商家接款、开发执行、SPU上传、开发完成等阶段。这个完整链路展示了买手与商家之间如何通过系统协同完成一款新商品的从无到有，是理解SCM系统业务逻辑的最佳切入点。

**推款到开发成功完整链路图：**

```
【买手推送阶段】
买手创建私推 → 设置款式信息 → 选择目标店铺 → 提交私推
    ↓
后端创建记录 → 通知商家
    ↓
【商家接款阶段】
商家发现新私推 → 查看款式详情 → 决定接款 → 点击接款
    ↓
后端更新状态 → 款式进入开发队列
    ↓
【开发执行阶段】
商家更新开发状态 → 打样中/改图帮看中/待上传SPU
    ↓
提交状态更新 → 买手端同步状态
    ↓
【SPU上传阶段】
商家上传SPU编码 → 填写SPU信息 → 确认上传
    ↓
后端记录SPU → 状态更新为待上传SPU
    ↓
【开发完成阶段】
商家标记开发成功 → 后端更新状态
    ↓
更新统计数据 → 通知买手完成
    ↓
流程闭环
```

### 5.2 申请到审批完成完整链路

从商家提交申请到买手审批完成展示了SCM系统的申请审批流程，包括核价申请、异常申请等不同申请类型的完整链路。这个链路体现了买手与商家之间的业务交互和决策过程。

**申请到审批完成完整链路图：**

```
【商家提交申请】
商家选择申请类型 → 填写申请信息 → 关联目标商品
    ↓
填写申请理由 → 提交申请
    ↓
后端创建申请记录 → 设置status=processing → 返回申请ID
    ↓
【买手获取工单】
买手获取待处理列表 → 筛选status=processing → 展示待处理工单
    ↓
买手选择工单处理
    ↓
【买手审批操作】
查看申请详情 → 填写审批信息 → 选择操作类型
    ↓
┌─────────────────────────────────┐
│  审批通过                        │
│  → 设置买手价格                  │
│  → 更新status=approved          │
│  → 记录反馈信息                  │
│  → 返回成功响应                  │
│                                  │
│  审批驳回                        │
│  → 填写驳回原因                  │
│  → 更新status=rejected          │
│  → 返回成功响应                  │
└─────────────────────────────────┘
    ↓
【商家端同步】
轮询监听 → 发现状态变化 → 前端更新状态 → 展示审批结果
    ↓
流程结束
```

### 5.3 补货从发起到入仓完整链路

从买手发起补货到商家发货、买手确认入仓展示了SCM系统的补货协同完整链路。这个链路涵盖了补货订单的创建、确认、生产、发货、入仓等完整阶段，是理解SCM系统供应链协同能力的关键场景。

**补货从发起到入仓完整链路图：**

```
【买手发起】
买手创建补货订单 → 选择目标商家 → 选择补货商品
    ↓
设置计划数量 → 设置截止日期 → 提交补货订单
    ↓
后端创建记录 → 通知商家确认 → 设置status=confirming
    ↓
【商家确认】
商家查看待确认订单 → 填写实际接单数量
    ↓
有砍量？→ 是 → 填写砍量理由 → 提交接单
           ↓
           否 → 提交接单
    ↓
后端确认接单
    ↓
有砍量？→ 是 → 买手审核砍量 → 同意/拒绝砍量 → 订单进入生产
           ↓
           否 → 订单进入生产
    ↓
设置status=生产中
    ↓
【商家发货】
商家准备发货 → 填写物流单号 → 选择物流公司
    ↓
确认发货数量 → 提交发货
    ↓
后端处理发货 → 创建物流记录 → 设置status=待买手确认入仓
    ↓
等待买手确认
    ↓
【买手入仓确认】
买手收到实物 → 核对到货数量 → 确认入仓
    ↓
后端更新状态 → 设置status=已确认入仓 → 记录arrived_at
    ↓
通知商家完成
    ↓
补货订单闭环
```

---

## 第六章 异常处理与错误反馈机制

### 6.1 异常分类与处理策略

SCM系统的前后端交互过程中可能出现多种类型的异常，需要针对不同异常采用相应的处理策略。业务异常发生在业务规则校验失败时，如配额已满、状态不允许操作等；权限异常发生在用户越权访问时；数据异常发生在数据不存在或冲突时；系统异常发生在服务器内部错误时。前端需要根据异常类型展示不同的错误提示，引导用户进行相应的操作。

**异常分类与处理流程图：**

```
API请求发起
    ↓
接收HTTP响应
    ↓
┌─────────────────────────────────┐
│  状态码分类                      │
├─────────────────────────────────┤
│  2xx → 成功处理                 │
│  4xx → 客户端异常               │
│  5xx → 系统异常                 │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────┐
│  4xx 客户端异常处理                                    │
├─────────────────┬───────────────────────────────────┤
│  业务异常 400   │  展示业务错误提示                  │
│                │  允许用户修改后重试                │
├─────────────────┼───────────────────────────────────┤
│  权限异常 403   │  展示权限不足提示                  │
│                │  跳转登录或联系管理员              │
├─────────────────┼───────────────────────────────────┤
│  数据异常       │  展示数据异常提示                  │
│  404/409       │  刷新数据后重试                    │
└─────────────────┴───────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────┐
│  5xx 系统异常处理                                    │
├─────────────────────────────────────────────────────┤
│  展示系统错误提示                                    │
│  自动重试机制                                        │
│  记录错误日志                                        │
└─────────────────────────────────────────────────────┘
```

### 6.2 关键业务场景错误处理

SCM系统的关键业务场景包括推款接款、申请审批和补货订单等，每个场景都有特定的错误类型和处理逻辑。

**关键业务错误处理流程图：**

```
【推款接款错误处理】
商家点击接款
    ↓
POST /api/styles/{id}/express_intent
    ↓
配额检查
    ↓
┌─────────────────────┐
│  配额已满 (current≥5)│
└─────────┬───────────┘
        是  │  否
        ↓   ↓
    返回    处理接款
    QUOTA_  意向
    EXCEEDED
        ↓   ↓
    展示    intent_count
    Toast   +=1
    提示
        ↓   ↓
    禁用    添加shop_id
    接款    到intent_
    按钮    user_ids
        ↓
    ┌───────────────────────┐
    │  已满额？ (intent≥max)  │
    └───────────┬───────────┘
            是  │  否
            ↓   ↓
        返回  返回接款
        STYLE 成功
        _FULL
            ↓   ↓
        隐藏  更新商家
        该款式  配额统计
```

**申请审批错误处理流程图：**

```
买手提交审批
    ↓
POST /api/requests/{id}/audit
    ↓
状态检查
    ↓
┌─────────────────────┐
│  状态不允许操作      │
└─────────┬───────────┘
        是  │  否
        ↓   ↓
    返回    处理审批
    INVALID 操作
    _STATUS
        ↓   ↓
    禁用    返回成功
    非法    响应
    操作
    按钮
        ↓
    提示当前可用操作
```

**补货订单错误处理流程图：**

```
商家提交发货
    ↓
POST /api/restock/{id}/ship
    ↓
参数验证
    ↓
┌─────────────────────────┐
│  物流单号为空？          │
└───────────┬─────────────┘
        是  │  否
        ↓   ↓
    返回    数量验证
    参数
    错误
        ↓
        ┌─────────────────────┐
        │  发货数量 > 计划数量？│
        └─────────┬───────────┘
              是  │  否
              ↓   ↓
          返回  处理发货
          数量
          超限
          错误
              ↓
              更新订单状态
              → 待买手确认入仓
```

---

## 第七章 文档总结

本文档详细分析了SCM协同管理系统中买手前端与商家前端四大核心功能的交互工作流。通过流程图的形式，清晰展示了以下核心内容：

**第一部分**展示了商家端完整操作流程，包括申请工作台（核价申请、异常申请）、款式工作台（私推接款、公池接款）、补货协同（接单确认、发货跟踪）和开发进度跟踪四个核心模块的操作路径和业务逻辑。

**第二部分**展示了买手段完整操作流程，包括系统驾驶舱（数据监控）、推款管理（私推创建、公池推送）、审批工单（核价审批、异常审批）、补货订单（发起创建、入仓确认）和店铺管理（注册审批）五个核心模块的操作路径和业务逻辑。

**第三部分**详细说明了前后端交互的数据流转机制，包括整体数据流转架构、API请求响应数据格式规范、核心业务数据流转详解和状态同步机制。

**第四部分**提供了关键业务场景的完整链路流程图，包括推款到开发成功完整链路、申请到审批完成完整链路和补货从发起到入仓完整链路。

**第五部分**总结了异常处理与错误反馈机制，包括异常分类与处理策略和关键业务场景错误处理。

本文档适用于系统开发人员、业务分析人员和项目管理人员，帮助其全面理解SCM系统的业务逻辑和交互流程。

---

**文档结束**
